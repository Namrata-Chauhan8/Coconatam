<!-- /*
* Bootstrap 5
* Template Name: Furni
* Template Author: Untree.co
* Template URI: https://untree.co/
* License: https://creativecommons.org/licenses/by/3.0/
*/ -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Untree.co">
  <link rel="shortcut icon" href="favicon.png">

  <meta name="description" content="" />
  <meta name="keywords" content="bootstrap, bootstrap4" />

  <!-- Bootstrap CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="css/tiny-slider.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <title>Checkout - Coconutam</title>
</head>

<body>

  <!-- Start Header/Navigation -->
  <nav class="custom-navbar navbar navbar navbar-expand-md navbar-dark bg-dark" arial-label="Furni navigation bar">

    <div class="container">
      <a class="navbar-brand" href="index.html"><img src="./images/white-transparent-logo.svg" alt="main-logo"
          width="120px"></a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsFurni"
        aria-controls="navbarsFurni" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsFurni">
        <ul class="custom-navbar-nav navbar-nav ms-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li><a class="nav-link" href="shop.html">Shop</a></li>
          <li><a class="nav-link" href="about.html">About us</a></li>
          <li><a class="nav-link" href="contact.html">Contact us</a></li>
        </ul>

        <ul class="custom-navbar-cta navbar-nav mb-2 mb-md-0 ms-5">
          <li><a class="nav-link" href="cart.html"><img src="images/cart.svg"></a></li>
        </ul>
      </div>
    </div>

  </nav>
  <!-- End Header/Navigation -->

  <!-- Start Hero Section -->
  <div class="hero">
    <div class="container">
      <div class="row justify-content-between">
        <div class="col-lg-5">
          <div class="intro-excerpt">
            <h1>Checkout</h1>
            <p class="mb-4">Complete your purchase securely.</p>
          </div>
        </div>
        <div class="col-lg-7">

        </div>
      </div>
    </div>
  </div>
  <!-- End Hero Section -->

  <!-- Start Checkout Section -->
  <div class="untree_co-section before-footer-section">
    <div class="container">
      <div class="row">
        <!-- Order Summary -->
        <div class="col-md-8">
          <div class="card shadow mb-4">
            <div class="card-header">
              <h4>Order Summary</h4>
            </div>
            <div class="card-body">
              <div id="orderItems">
                <p class="text-muted">Loading order items...</p>
              </div>
            </div>
          </div>

          <!-- Shipping Address -->
          <div class="card shadow mb-4">
            <div class="card-header">
              <h4>Shipping Address</h4>
            </div>
            <div class="card-body">
              <form id="shippingForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Full Name</label>
                      <input type="text" class="form-control" id="shippingName" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Phone Number</label>
                      <input type="tel" class="form-control" id="shippingPhone" required>
                    </div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Address</label>
                  <textarea class="form-control" id="shippingAddress" rows="3" required></textarea>
                </div>
                
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">City</label>
                      <input type="text" class="form-control" id="shippingCity" required>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">State</label>
                      <input type="text" class="form-control" id="shippingState" required>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Pincode</label>
                      <input type="text" class="form-control" id="shippingPincode" required>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Payment Summary -->
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-header">
              <h4>Payment Summary</h4>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="subtotal">₹0</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Tax (18%):</span>
                <span id="tax">₹0</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Shipping:</span>
                <span id="shipping">₹0</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between mb-3">
                <strong>Total:</strong>
                <strong id="total">₹0</strong>
              </div>
              
              <div class="d-grid">
                <button class="btn btn-black btn-lg py-3" onclick="proceedToPayment()">
                  <i class="fas fa-credit-card me-2"></i>Proceed to Payment
                </button>
              </div>
              
              <div class="text-center mt-3">
                <small class="text-muted">
                  <i class="fas fa-lock me-1"></i>
                  Secure payment powered by Razorpay
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- End Checkout Section -->

  <!-- Start Footer Section -->
  <footer class="footer-section">
    <div class="container relative">

      <div class="product-img">
        <img src="images/co-bowl-set.png" alt="Image" class="img-fluid">
      </div>

      <div class="row g-5 mb-5">
        <div class="col-lg-6">
          <div class="mb-4 footer-logo-wrap"><img src="./images/color transparent-logo.svg" alt="logo" width="170px">
          </div>
          <p class="mb-4">Coconutam is dedicated to creating eco-friendly products from natural coconut
            shells. Blending sustainability with style, we offer handcrafted items that celebrate nature,
            tradition, and thoughtful living.</p>

          <ul class="list-unstyled custom-social">
            <li><a href="#"><span class="fa fa-brands fa-facebook-f"></span></a></li>
            <li><a href="#"><span class="fa fa-brands fa-twitter"></span></a></li>
            <li><a href="#"><span class="fa fa-brands fa-instagram"></span></a></li>
            <li><a href="#"><span class="fa fa-brands fa-linkedin"></span></a></li>
          </ul>
        </div>

        <div class="col-lg-6">
          <div class="row links-wrap">
            <div class="col-6 col-sm-6 col-md-3">
              <ul class="list-unstyled">
                <li><a href="./about.html">About us</a></li>
                <li><a href="./shop.html">Shop</a></li>
                <li><a href="./contact.html">Contact us</a></li>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </footer>
  <!-- End Footer Section -->

  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/tiny-slider.js"></script>
  <script src="js/custom.js"></script>
  
  <script>
    // === CONFIGURATION ===
    // Set your Razorpay key here (from Razorpay dashboard)
    const RAZORPAY_KEY = 'rzp_test_YOUR_KEY_ID'; // <-- REPLACE with your real Razorpay key
    const API_BASE_URL = 'http://localhost:5000/api';

    let isProcessingPayment = false;

    function setLoading(isLoading) {
      const btn = document.querySelector('.btn.btn-black.btn-lg.py-3');
      if (btn) {
        btn.disabled = isLoading;
        btn.innerHTML = isLoading
          ? '<span class="spinner-border spinner-border-sm me-2"></span>Processing...'
          : '<i class="fas fa-credit-card me-2"></i>Proceed to Payment';
      }
    }

    function showDialog(message, title = 'Notice') {
      document.getElementById('checkoutDialogModalLabel').textContent = title;
      document.getElementById('checkoutDialogModalBody').textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('checkoutDialogModal'));
      modal.show();
      setTimeout(() => {
        modal.hide();
      }, 3000);
    }

    window.addEventListener('load', function() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      loadCart();
    });

    async function loadCart() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/cart`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (response.ok) {
          displayOrderSummary(data.data.cart);
        } else {
          showDialog(data.message || 'Error loading cart', 'Error');
        }
      } catch (error) {
        showDialog('Error loading cart', 'Error');
      }
    }

    function displayOrderSummary(cart) {
      const orderItemsContainer = document.getElementById('orderItems');
      if (cart.items.length === 0) {
        orderItemsContainer.innerHTML = '<p class="text-muted">Your cart is empty</p>';
        return;
      }
      let itemsHtml = '';
      let subtotal = 0;
      cart.items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        itemsHtml += `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div class="d-flex align-items-center">
              <img src="${item.product.images ? item.product.images[0] : 'images/co-bowl.png'}" 
                   alt="${item.product.name}" style="width: 50px; height: 50px; object-fit: cover;" class="me-3">
              <div>
                <strong>${item.product.name}</strong><br>
                <small class="text-muted">Quantity: ${item.quantity}</small>
              </div>
            </div>
            <div class="text-end">
              <strong>₹${itemTotal}</strong>
            </div>
          </div>
        `;
      });
      orderItemsContainer.innerHTML = itemsHtml;
      const tax = subtotal * 0.18;
      const shipping = subtotal > 1000 ? 0 : 100;
      const total = subtotal + tax + shipping;
      document.getElementById('subtotal').textContent = `₹${subtotal}`;
      document.getElementById('tax').textContent = `₹${tax.toFixed(2)}`;
      document.getElementById('shipping').textContent = `₹${shipping}`;
      document.getElementById('total').textContent = `₹${total.toFixed(2)}`;
    }

    async function proceedToPayment() {
      if (isProcessingPayment) return;
      isProcessingPayment = true;
      setLoading(true);
      const token = localStorage.getItem('token');
      const shippingName = document.getElementById('shippingName').value;
      const shippingPhone = document.getElementById('shippingPhone').value;
      const shippingAddress = document.getElementById('shippingAddress').value;
      const shippingCity = document.getElementById('shippingCity').value;
      const shippingState = document.getElementById('shippingState').value;
      const shippingPincode = document.getElementById('shippingPincode').value;
      if (!shippingName || !shippingPhone || !shippingAddress || !shippingCity || !shippingState || !shippingPincode) {
        showDialog('Please fill in all shipping details', 'Error');
        setLoading(false); isProcessingPayment = false; return;
      }
      try {
        const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const cartData = await cartResponse.json();
        if (!cartResponse.ok || cartData.data.cart.items.length === 0) {
          showDialog('Your cart is empty', 'Error');
          setLoading(false); isProcessingPayment = false; return;
        }
        const orderResponse = await fetch(`${API_BASE_URL}/payments/create-order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({
            cartId: cartData.data.cart._id,
            shippingAddress: {
              name: shippingName,
              phone: shippingPhone,
              address: shippingAddress,
              city: shippingCity,
              state: shippingState,
              pincode: shippingPincode,
              country: 'India'
            }
          })
        });
        const orderData = await orderResponse.json();
        if (orderResponse.ok) {
          const options = {
            key: RAZORPAY_KEY,
            amount: orderData.data.razorpayOrder.amount,
            currency: 'INR',
            name: 'Coconutam',
            description: 'Order Payment',
            order_id: orderData.data.razorpayOrder.id,
            handler: function(response) {
              verifyPayment(response, orderData.data.order.orderId);
            },
            prefill: {
              name: shippingName,
              contact: shippingPhone
            },
            theme: { color: '#2c3e50' }
          };
          const rzp = new Razorpay(options);
          rzp.open();
        } else {
          showDialog(orderData.message || 'Error creating order', 'Error');
        }
      } catch (error) {
        showDialog('Error processing payment', 'Error');
      } finally {
        setLoading(false); isProcessingPayment = false;
      }
    }

    async function verifyPayment(response, orderId) {
      const token = localStorage.getItem('token');
      try {
        const verifyResponse = await fetch(`${API_BASE_URL}/payments/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            orderId: orderId
          })
        });
        const verifyData = await verifyResponse.json();
        if (verifyResponse.ok) {
          showDialog('Payment successful! Your order has been placed.', 'Success');
          setTimeout(() => { window.location.href = 'thankyou.html'; }, 2000);
        } else {
          showDialog('Payment verification failed: ' + verifyData.message, 'Error');
        }
      } catch (error) {
        showDialog('Error verifying payment', 'Error');
      }
    }
  </script>
  
  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>

</html>
