<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="author" content="Untree.co" />
    <link rel="shortcut icon" href="../favicon.png" />

    <meta name="description" content="" />
    <meta name="keywords" content="bootstrap, bootstrap4" />

    <!-- Bootstrap CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link href="../css/tiny-slider.css" rel="stylesheet" />
    <link href="../css/style.css" rel="stylesheet" />
    <title>Admin Dashboard - Coconutam</title>

    <style>
      .sidebar {
        min-height: 100vh;
        background: #2c3e50;
        color: white;
      }
      .sidebar .nav-link {
        color: #ecf0f1;
        padding: 12px 20px;
        border-radius: 5px;
        margin: 2px 0;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background: #34495e;
        color: white;
      }
      .sidebar .nav-link i {
        width: 20px;
        margin-right: 10px;
      }
      .main-content {
        background: #f8f9fa;
        min-height: 100vh;
      }
      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .stats-card h3 {
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .stats-card .number {
        font-size: 2rem;
        font-weight: bold;
        color: #27ae60;
      }
      .table-responsive {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .btn-admin {
        background: #2c3e50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
      }
      .btn-admin:hover {
        background: #34495e;
        color: white;
      }
      .navbar-admin {
        background: #34495e !important;
      }
    </style>
  </head>

  <body>
    <!-- Admin Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-admin">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img
            src="../images/white-transparent-logo.svg"
            alt="Coconutam"
            width="120px"
          />
          <span class="ms-2">Admin Panel</span>
        </a>

        <div class="navbar-nav ms-auto">
          <div class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdown"
              role="button"
              data-bs-toggle="dropdown"
            >
              <i class="fas fa-user me-2"></i>
              <span id="adminName">Admin</span>
            </a>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="#" onclick="showProfile()"
                  ><i class="fas fa-user-cog me-2"></i>Profile</a
                >
              </li>
              <li>
                <a class="dropdown-item" href="#" onclick="logout()"
                  ><i class="fas fa-sign-out-alt me-2"></i>Logout</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0">
          <div class="sidebar">
            <div class="p-3">
              <h5 class="text-center mb-4">Admin Menu</h5>
              <nav class="nav flex-column">
                <a class="nav-link active" href="#" onclick="showDashboard(event)">
                  <i class="fas fa-tachometer-alt"></i>Dashboard
                </a>
                <a class="nav-link" href="#" onclick="showProducts(event)">
                  <i class="fas fa-box"></i>Products
                </a>
                <a class="nav-link" href="#" onclick="showOrders(event)">
                  <i class="fas fa-shopping-cart"></i>Orders
                </a>
                <a class="nav-link" href="#" onclick="showUsers(event)">
                  <i class="fas fa-users"></i>Users
                </a>
                <a class="nav-link" href="#" onclick="showAnalytics(event)">
                  <i class="fas fa-chart-bar"></i>Analytics
                </a>
                <a class="nav-link" href="#" onclick="showSettings(event)">
                  <i class="fas fa-cog"></i>Settings
                </a>
              </nav>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
          <div class="main-content p-4">
            <!-- Dashboard Content -->
            <div id="dashboard-content">
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h2>Dashboard</h2>
                <div class="text-muted">
                  Welcome back, <span id="welcomeName">Admin</span>!
                </div>
              </div>

              <!-- Stats Cards -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card">
                    <h3>
                      <i class="fas fa-box text-primary me-2"></i>Total Products
                    </h3>
                    <div class="number" id="totalProducts">0</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <h3>
                      <i class="fas fa-shopping-cart text-success me-2"></i
                      >Total Orders
                    </h3>
                    <div class="number" id="totalOrders">0</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <h3>
                      <i class="fas fa-users text-info me-2"></i>Total Users
                    </h3>
                    <div class="number" id="totalUsers">0</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <h3>
                      <i class="fas fa-rupee-sign text-warning me-2"></i>Revenue
                    </h3>
                    <div class="number" id="totalRevenue">₹0</div>
                  </div>
                </div>
              </div>

              <!-- Recent Orders -->
              <div class="row">
                <div class="col-md-8">
                  <div class="table-responsive">
                    <h4>Recent Orders</h4>
                    <div id="recentOrders">
                      <p class="text-muted">Loading...</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="table-responsive">
                    <h4>Quick Actions</h4>
                    <div class="d-grid gap-2">
                      <button class="btn btn-admin" onclick="showAddProduct()">
                        <i class="fas fa-plus me-2"></i>Add New Product
                      </button>
                      <button class="btn btn-admin" onclick="showBulkImport()">
                        <i class="fas fa-upload me-2"></i>Bulk Import Products
                      </button>
                      <button class="btn btn-admin" onclick="showAnalytics()">
                        <i class="fas fa-chart-line me-2"></i>View Analytics
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Products Content -->
            <div id="products-content" style="display: none">
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h2>Products Management</h2>
                <button class="btn btn-admin" onclick="showAddProduct()">
                  <i class="fas fa-plus me-2"></i>Add Product
                </button>
              </div>

              <div class="table-responsive">
                <div class="mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="productSearch"
                    placeholder="Search products..."
                  />
                </div>
                <div id="productsTable">
                  <p class="text-muted">Loading products...</p>
                </div>
              </div>
            </div>

            <!-- Orders Content -->
            <div id="orders-content" style="display: none">
              <h2>Orders Management</h2>
              <div class="table-responsive">
                <div id="ordersTable">
                  <p class="text-muted">Loading orders...</p>
                </div>
              </div>
            </div>

            <!-- Users Content -->
            <div id="users-content" style="display: none">
              <h2>Users Management</h2>
              <div class="table-responsive">
                <div id="usersTable">
                  <p class="text-muted">Loading users...</p>
                </div>
              </div>
            </div>

            <!-- Analytics Content -->
            <div id="analytics-content" style="display: none">
              <h2>Analytics</h2>
              <div class="row">
                <div class="col-md-6">
                  <div class="table-responsive">
                    <h4>Sales Overview</h4>
                    <canvas id="salesChart"></canvas>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="table-responsive">
                    <h4>Top Products</h4>
                    <div id="topProducts">
                      <p class="text-muted">Loading...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Content -->
            <div id="settings-content" style="display: none">
              <h2>Settings</h2>
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Profile Settings</h5>
                      <form id="profileForm">
                        <div class="mb-3">
                          <label class="form-label">Name</label>
                          <input
                            type="text"
                            class="form-control"
                            id="profileName"
                          />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Email</label>
                          <input
                            type="email"
                            class="form-control"
                            id="profileEmail"
                            readonly
                          />
                        </div>
                        <button type="submit" class="btn btn-admin">
                          Update Profile
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Change Password</h5>
                      <form id="passwordForm">
                        <div class="mb-3">
                          <label class="form-label">Current Password</label>
                          <input
                            type="password"
                            class="form-control"
                            id="currentPassword"
                          />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">New Password</label>
                          <input
                            type="password"
                            class="form-control"
                            id="newPassword"
                          />
                        </div>
                        <button type="submit" class="btn btn-admin">
                          Change Password
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Product</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addProductForm" onsubmit="saveProduct(event)">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Product Name</label>
                    <input
                      type="text"
                      class="form-control"
                      name="name"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select class="form-control" name="category" required>
                      <option value="">Select Category</option>
                      <option value="Candles">Candles</option>
                      <option value="Kitchenware">Kitchenware</option>
                      <option value="Garden Decor">Garden Decor</option>
                      <option value="Office Accessories">
                        Office Accessories
                      </option>
                      <option value="Home Decor">Home Decor</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Price (₹)</label>
                    <input
                      type="number"
                      class="form-control"
                      name="price"
                      min="0"
                      step="0.01"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Stock Quantity</label>
                    <input
                      type="number"
                      class="form-control"
                      name="stock"
                      min="0"
                      required
                    />
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Size</label>
                <input type="text" class="form-control" name="size" required />
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  name="description"
                  rows="3"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Images (URLs, one per line)</label>
                <textarea
                  class="form-control"
                  name="images"
                  rows="3"
                  placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Tags (comma separated)</label>
                <input
                  type="text"
                  class="form-control"
                  name="tags"
                  placeholder="coconut, handcrafted, eco-friendly"
                />
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-admin">Save Product</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Global Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalLabel">Message</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="messageModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Global Confirm Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">Confirm</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="confirmModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmModalCancel">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmModalOk">Yes</button>
          </div>
        </div>
      </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="../js/tiny-slider.js"></script>
    <script src="../js/custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // API Configuration
      const API_BASE_URL = "http://localhost:5000/api";
      let currentUser = null;
      let editingProductId = null;

      // Check authentication on page load
      window.addEventListener("load", function () {
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user") || "{}");

        if (!token || !user.id) {
          window.location.href = "../login.html";
          return;
        }

        if (user.role !== "admin") {
          window.location.href = "../index.html";
          return;
        }

        currentUser = user;
        document.getElementById("adminName").textContent = user.name;
        document.getElementById("welcomeName").textContent = user.name;

        loadDashboard();
      });

      // Navigation functions
      function showDashboard(event) {
        hideAllContent();
        document.getElementById("dashboard-content").style.display = "block";
        document.querySelector(".nav-link.active").classList.remove("active");
        if (event) event.target.classList.add("active");
        loadDashboard();
      }

      function showProducts(event) {
        hideAllContent();
        document.getElementById("products-content").style.display = "block";
        document.querySelector(".nav-link.active").classList.remove("active");
        if (event) event.target.classList.add("active");
        loadProducts();
      }

      function showOrders(event) {
        hideAllContent();
        document.getElementById("orders-content").style.display = "block";
        document.querySelector(".nav-link.active").classList.remove("active");
        if (event) event.target.classList.add("active");
        loadOrders();
      }

      function showUsers(event) {
        hideAllContent();
        document.getElementById("users-content").style.display = "block";
        document.querySelector(".nav-link.active").classList.remove("active");
        if (event) event.target.classList.add("active");
        loadUsers();
      }

      function showAnalytics(event) {
        hideAllContent();
        document.getElementById("analytics-content").style.display = "block";
        document.querySelector(".nav-link.active").classList.remove("active");
        if (event) event.target.classList.add("active");
        loadAnalytics();
      }

      function showSettings(event) {
        hideAllContent();
        document.getElementById("settings-content").style.display = "block";
        document.querySelector(".nav-link.active").classList.remove("active");
        if (event) event.target.classList.add("active");
        loadSettings();
      }

      function hideAllContent() {
        const contents = [
          "dashboard-content",
          "products-content",
          "orders-content",
          "users-content",
          "analytics-content",
          "settings-content",
        ];
        contents.forEach((id) => {
          document.getElementById(id).style.display = "none";
        });
      }

      // API call utility
      async function apiCall(endpoint, options = {}) {
        const token = localStorage.getItem("token");

        try {
          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
              ...options.headers,
            },
            ...options,
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "API call failed");
          }

          return data;
        } catch (error) {
          console.error("API Error:", error);
          throw error;
        }
      }

      // Load dashboard data
      async function loadDashboard() {
        try {
          const [products, orders] = await Promise.all([
            apiCall("/products?limit=1000"),
            apiCall("/orders"),
          ]);

          document.getElementById("totalProducts").textContent =
            products.data.pagination.totalItems;
          document.getElementById("totalOrders").textContent =
            orders.data.pagination.totalItems;
          document.getElementById("totalUsers").textContent = "25"; // Mock data
          document.getElementById("totalRevenue").textContent = "₹45,000"; // Mock data

          // Load recent orders
          const recentOrders = orders.data.orders.slice(0, 5);
          const ordersHtml = recentOrders
            .map(
              (order) => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div>
              <strong>${order.orderId}</strong><br>
              <small class="text-muted">${new Date(
                order.createdAt
              ).toLocaleDateString()}</small>
            </div>
            <div class="text-end">
              <span class="badge bg-${
                order.status === "pending"
                  ? "warning"
                  : order.status === "confirmed"
                  ? "success"
                  : "secondary"
              }">${order.status}</span><br>
              <strong>₹${order.total}</strong>
            </div>
          </div>
        `
            )
            .join("");

          document.getElementById("recentOrders").innerHTML =
            ordersHtml || '<p class="text-muted">No recent orders</p>';
        } catch (error) {
          console.error("Error loading dashboard:", error);
        }
      }

      // Load products
      async function loadProducts() {
        try {
          const response = await apiCall("/products?limit=1000");
          const products = response.data.products;

          const productsHtml = products
            .map(
              (product) => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div class="d-flex align-items-center">
              <img src="${product.images[0] || "../images/co-bowl.png"}" alt="${
                product.name
              }" style="width: 50px; height: 50px; object-fit: cover;" class="me-3">
              <div>
                <strong>${product.name}</strong><br>
                <small class="text-muted">${product.category} • Stock: ${
                product.stock
              }</small>
              </div>
            </div>
            <div class="text-end">
              <strong>₹${product.price}</strong><br>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="editProduct('${
                  product._id
                }')">Edit</button>
                <button class="btn btn-outline-danger" onclick="deleteProduct('${
                  product._id
                }')">Delete</button>
              </div>
            </div>
          </div>
        `
            )
            .join("");

          document.getElementById("productsTable").innerHTML =
            productsHtml || '<p class="text-muted">No products found</p>';
        } catch (error) {
          console.error("Error loading products:", error);
          document.getElementById("productsTable").innerHTML =
            '<p class="text-danger">Error loading products</p>';
        }
      }

      // Load orders
      async function loadOrders() {
        try {
          const response = await apiCall("/orders");
          const orders = response.data.orders;

          const ordersHtml = orders
            .map(
              (order) => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div>
              <strong>${order.orderId}</strong><br>
              <small class="text-muted">${order.userId} • ${new Date(
                order.createdAt
              ).toLocaleDateString()}</small>
            </div>
            <div class="text-end">
              <span class="badge bg-${
                order.status === "pending"
                  ? "warning"
                  : order.status === "confirmed"
                  ? "success"
                  : "secondary"
              }">${order.status}</span><br>
              <strong>₹${order.total}</strong>
            </div>
          </div>
        `
            )
            .join("");

          document.getElementById("ordersTable").innerHTML =
            ordersHtml || '<p class="text-muted">No orders found</p>';
        } catch (error) {
          console.error("Error loading orders:", error);
          document.getElementById("ordersTable").innerHTML =
            '<p class="text-danger">Error loading orders</p>';
        }
      }

      // Load users (mock data for now)
      async function loadUsers() {
        try {
          const response = await apiCall("/auth/all"); // Adjust endpoint if needed
          const users = response.data.users;

          const usersHtml = users
            .map(
              (user) => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
              <div>
                <strong>${user.name}</strong><br>
                <small class="text-muted">${user.email} • ${user.role}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-${user.isActive ? 'success' : 'danger'}">${user.isActive ? 'Active' : 'Inactive'}</span>
              </div>
            </div>
          `
            )
            .join("");

          document.getElementById("usersTable").innerHTML =
            usersHtml || '<p class="text-muted">No users found</p>';
        } catch (error) {
          document.getElementById("usersTable").innerHTML =
            '<p class="text-danger">Error loading users</p>';
        }
      }

      // Load analytics
      function loadAnalytics() {
        // Mock analytics data
        const ctx = document.getElementById("salesChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Sales",
                data: [12, 19, 3, 5, 2, 3],
                borderColor: "#27ae60",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });

        document.getElementById("topProducts").innerHTML = `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
          <div>Coconut Shell Candle</div>
          <div>₹15,000</div>
        </div>
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
          <div>Tea Cup Set</div>
          <div>₹12,000</div>
        </div>
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
          <div>Garden Planter</div>
          <div>₹8,000</div>
        </div>
      `;
      }

      // Load settings
      function loadSettings() {
        document.getElementById("profileName").value = currentUser.name;
        document.getElementById("profileEmail").value = currentUser.email;
      }

      // Product management
      function showAddProduct() {
        editingProductId = null; // Reset edit mode
        const form = document.getElementById("addProductForm");
        form.reset();
        const modal = new bootstrap.Modal(document.getElementById("addProductModal"));
        modal.show();
      }

      async function editProduct(productId) {
        try {
          const response = await apiCall(`/products/${productId}`);
          const product = response.data.product;

          // Fill the form with product data
          const form = document.getElementById("addProductForm");
          form.name.value = product.name;
          form.category.value = product.category;
          form.price.value = product.price;
          form.stock.value = product.stock;
          form.size.value = product.size;
          form.description.value = product.description;
          form.images.value = product.images.join("\n");
          form.tags.value = product.tags.join(", ");

          editingProductId = productId;

          // Show the modal
          const modal = new bootstrap.Modal(document.getElementById("addProductModal"));
          modal.show();
        } catch (error) {
          showDialog("Error loading product: " + error.message, "Error");
        }
      }

      async function saveProduct(event) {
        event.preventDefault();
        const form = document.getElementById("addProductForm");
        const formData = new FormData(form);

        const productData = {
          name: formData.get("name"),
          category: formData.get("category"),
          price: parseFloat(formData.get("price")),
          stock: parseInt(formData.get("stock")),
          size: formData.get("size"),
          description: formData.get("description"),
          images: formData.get("images").split("\n").filter((url) => url.trim()),
          tags: formData.get("tags").split(",").map((tag) => tag.trim()).filter((tag) => tag),
          currency: "INR",
        };

        try {
          if (editingProductId) {
            // Edit mode
            await apiCall(`/products/${editingProductId}`, {
              method: "PUT",
              body: JSON.stringify(productData),
            });
            editingProductId = null;
            showDialog("Product updated successfully!", "Success");
          } else {
            // Add mode
            await apiCall("/products", {
              method: "POST",
              body: JSON.stringify(productData),
            });
            showDialog("Product added successfully!", "Success");
          }

          bootstrap.Modal.getInstance(document.getElementById("addProductModal")).hide();
          form.reset();
          showProducts();
        } catch (error) {
          showDialog("Error saving product: " + error.message, "Error");
        }
      }

      async function deleteProduct(productId) {
        showConfirm("Are you sure you want to delete this product?", async function() {
          try {
            await apiCall(`/products/${productId}`, {
              method: "DELETE"
            });
            showDialog("Product deleted successfully!", "Success");
            loadProducts();
          } catch (error) {
            showDialog("Error deleting product: " + error.message, "Error");
          }
        }, "Delete Product");
      }

      // Logout function
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "../login.html";
      }

      // Profile functions
      function showProfile() {
        showSettings();
      }

      // Handle profile form submission
      document
        .getElementById("profileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const profileData = {
            name: document.getElementById("profileName").value,
          };

          try {
            await apiCall("/auth/profile", {
              method: "PUT",
              body: JSON.stringify(profileData),
            });

            showDialog("Profile updated successfully!", "Success");
            currentUser.name = profileData.name;
            document.getElementById("adminName").textContent = currentUser.name;
            document.getElementById("welcomeName").textContent =
              currentUser.name;
          } catch (error) {
            showDialog("Error updating profile: " + error.message, "Error");
          }
        });

      // Handle password form submission
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const passwordData = {
            currentPassword: document.getElementById("currentPassword").value,
            newPassword: document.getElementById("newPassword").value,
          };

          try {
            await apiCall("/auth/change-password", {
              method: "PUT",
              body: JSON.stringify(passwordData),
            });

            showDialog("Password changed successfully!", "Success");
            document.getElementById("passwordForm").reset();
          } catch (error) {
            showDialog("Error changing password: " + error.message, "Error");
          }
        });

      function showDialog(message, title = "Message") {
        document.getElementById("messageModalLabel").textContent = title;
        document.getElementById("messageModalBody").textContent = message;
        const modal = new bootstrap.Modal(document.getElementById("messageModal"));
        modal.show();
      }

      function showConfirm(message, onConfirm, title = "Confirm") {
        document.getElementById("confirmModalLabel").textContent = title;
        document.getElementById("confirmModalBody").textContent = message;
        const modalEl = document.getElementById("confirmModal");
        const modal = new bootstrap.Modal(modalEl);
        const okBtn = document.getElementById("confirmModalOk");
        const cancelBtn = document.getElementById("confirmModalCancel");

        // Remove previous listeners
        okBtn.onclick = null;
        cancelBtn.onclick = null;

        okBtn.onclick = function() {
          modal.hide();
          if (onConfirm) onConfirm();
        };
        cancelBtn.onclick = function() {
          modal.hide();
        };
        modal.show();
      }
    </script>
  </body>
</html>
